
<dom-module id="tm-screen-one">
  <template>
    <style>
      :host {
        display: block;
      }
      h2 {
        text-align: center;
      }
      paper-card {
        vertical-align: top;
        width:50%;
      }
      paper-card.left {
        clear:both;
        float:left;
      }
      paper-dropdown-menu {
        width:100%;
      }
    </style>

    <iron-ajax auto url="/table" handle-as="json" last-response="{{tableList}}"></iron-ajax>
    <iron-ajax auto url="[[_computeFieldsUrl(table)]]" handle-as="json" last-response="{{fieldList}}"></iron-ajax>
    <iron-ajax auto url="[[_computeOptionsUrl(table)]]" handle-as="json" last-response="{{fieldOptionMap}}"></iron-ajax>
    <iron-ajax id="value" method="POST" url="[[_computeValueUrl(table)]]" handle-as="json"
                          content-type="application/json" body="" last-response="{{value}}"></iron-ajax>

    <paper-material elevation="1">
      <h2>Screen one</h2>
      <paper-card class="left">
        <div class="card-content">
          <paper-dropdown-menu label="Tables">
            <paper-listbox class="dropdown-content" selected="{{selectedTable}}">
              <template is="dom-repeat" items="[[tableList]]" as="tableName">
                <paper-item>[[tableName]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </paper-card>
      <paper-card class="left">
        <div class="card-content">
          <span>[[value]]</span>
        </div>
        <div class="card-actions">
          <paper-button raised on-tap="_getValue">Get Value</paper-button>
        </div>
      </paper-card>
      <paper-card>
        <div class="card-content">
          <template is="dom-repeat" items="[[fieldObjects]]" as="field">
            <paper-dropdown-menu label="{{field.name}}">
              <paper-listbox class="dropdown-content" selected="{{field.value}}">
                <template is="dom-repeat" items="[[_getFieldOptions(table,field.name,fieldOptionMap)]]" as="option">
                  <paper-item>[[option]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
          </template>
        </div>
      </paper-card>
    </paper-material>
  </template>
  <script>
    (function(Polymer) {
      Polymer({
        is: 'tm-screen-one',
        properties: {
          tableList: { type:Array, notify:true },
          fieldList: { type:Array, notify:true },
          fieldOptionMap: { type:Object, notify:true },
          fieldObjects: { type:Array, notify:true, computed: '_computeFieldObjects(fieldList)' },
          selectedTable: { type:Number, notify:true },
          table: { type:String, notify:true, computed: '_computeTable(tableList,selectedTable)'},
          value: { type:String, notify:true, value: '' }
        },
        observers: [
          'debug(fieldOptionMap)',
          '_tableListChanged(tableList)'
        ],
        _computeFieldsUrl: function(table) {
          return '/table/' + table + '/fields';
        },
        _computeOptionsUrl: function(table) {
          return '/table/' + table + '/options';
        },
        _computeValueUrl: function(table) {
          return '/table/' + table + '/value';
        },
        _getFieldOptions: function(table,fieldName,fieldOptionMap) {
          if (fieldOptionMap !== undefined) {
            return fieldOptionMap[fieldName];
          }
        },
        _createQuery: function(fieldObjects,fieldOptionMap) {
          const map = {};
          fieldObjects.forEach(function(field) {
            map[field.name] = fieldOptionMap[field.name][field.value];
          });
          return JSON.stringify(map);
        },
        _getValue: function() {
          this.$.value.body = this._createQuery(this.fieldObjects, this.fieldOptionMap);
          this.$.value.generateRequest();
        },
        _computeFieldObjects: function(fieldList) {
          return fieldList.map(field => ({name:field,value:0}));
        },
        _tableListChanged: function(tableList) {
          this.selectedTable = 0;
        },
        _computeTable: function(tableList, selectedTable) {
          return tableList[selectedTable];
        },
        debug: function(object) {
          console.log('-->> DEBUG: ', object);
        },
        ready: function() {
          console.log('Element tm-screen-one has been created.');
        }
      });
    })(window.Polymer);
  </script>
</dom-module>
